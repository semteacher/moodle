define ("core_message/message_drawer_view_overview_section",["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/str","core/templates","core/user_date","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_router","core_message/message_drawer_routes","core_message/message_drawer_lazy_load_list","core_message/message_drawer_view_conversation_constants"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n={TOGGLE:"[data-region=\"toggle\"]",CONVERSATION:"[data-conversation-id]",BLOCKED_ICON_CONTAINER:"[data-region=\"contact-icon-blocked\"]",LAST_MESSAGE:"[data-region=\"last-message\"]",LAST_MESSAGE_DATE:"[data-region=\"last-message-date\"]",MUTED_ICON_CONTAINER:"[data-region=\"muted-icon-container\"]",UNREAD_COUNT:"[data-region=\"unread-count\"]",SECTION_TOTAL_COUNT:"[data-region=\"section-total-count\"]",SECTION_TOTAL_COUNT_CONTAINER:"[data-region=\"section-total-count-container\"]",SECTION_UNREAD_COUNT:"[data-region=\"section-unread-count\"]",PLACEHOLDER_CONTAINER:"[data-region=\"placeholder-container\"]"},o={CONVERSATIONS_LIST:"core_message/message_drawer_conversations_list",CONVERSATIONS_LIST_ITEMS_PLACEHOLDER:"core_message/message_drawer_conversations_list_items_placeholder"},p=50,q={},r=!1,s=!1,t=function(a){return l.getRoot(a).hasClass("show")},u=function(a){a.addClass("expanded")},v=function(a){a.removeClass("expanded")},w=function(a,b){var c=a.find(n.SECTION_TOTAL_COUNT_CONTAINER),d=c.find(n.SECTION_TOTAL_COUNT);d.text(b);c.removeClass("hidden");e.get_string("totalconversations","core_message",b).done(function(a){c.attr("aria-label",a)});var g=20<b?20:b,h=Array.apply(null,Array(g)).map(function(){return!0});f.render(o.CONVERSATIONS_LIST_ITEMS_PLACEHOLDER,{placeholders:h}).then(function(b){var c=a.find(n.PLACEHOLDER_CONTAINER);c.html(b)}).catch(function(){})},x=function(a,b){var c=a.find(n.SECTION_UNREAD_COUNT);c.text(b);e.get_string("unreadconversations","core_message",b).done(function(a){c.attr("aria-label",a)});if(0<b){c.removeClass("hidden")}},y=function(b){var c=function(b){return Object.keys(b).reduce(function(d,e){if(a.isArray(b[e])){d[e.toLowerCase()]=b[e].map(c)}else{d[e.toLowerCase()]=b[e]}return d},{})},d=c(b);d.messages=d.messages.map(function(a){a.useridfrom=a.userfrom.id;return a});return d},z=function(b,c){var d=b.map(function(b){var d=b.messages.length?b.messages[b.messages.length-1]:null,e={id:b.id,imageurl:b.imageurl,name:b.name,subname:b.subname,unreadcount:b.unreadcount,ismuted:b.ismuted,lastmessagedate:d?d.timecreated:null,sentfromcurrentuser:d?d.useridfrom==c:null,lastmessage:d?a(d.text).text()||d.text:null},f=null;if(b.type==m.CONVERSATION_TYPES.SELF){f=b.members[0]}else if(b.type==m.CONVERSATION_TYPES.PRIVATE){f=b.members.reduce(function(a,b){if(!a&&b.id!=c){a=b}return a},null)}if(null!==f){e.userid=f.id;e.showonlinestatus=f.showonlinestatus;e.isonline=f.isonline;e.isblocked=f.isblocked}if(b.type==m.CONVERSATION_TYPES.PUBLIC){e.lastsendername=b.members.reduce(function(a,b){if(!a&&d&&b.id==d.useridfrom){a=b.fullname}return a},null)}return e});d.forEach(function(a){if(new Date().toDateString()==new Date(1e3*a.lastmessagedate).toDateString()){a.istoday=!0}});return f.render(o.CONVERSATIONS_LIST,{conversations:d})},A=function(a,b,d){var e=null,f=!0;if(a&&a.length){var g=a.filter(function(a){return a!=m.CONVERSATION_TYPES.SELF});f=a.length!=g.length;e=g[0]}return function(a,g){return h.getConversations(g,e,p+1,d,b,f).then(function(b){var c=b.conversations;if(c.length>p){c=c.slice(0,-1)}else{l.setLoadedAll(a,!0)}d=d+p;c.forEach(function(a){q[a.id]=a});return c}).catch(c.exception)}},B=function(a){return a.find(n.SECTION_TOTAL_COUNT)},C=function(a){return a.find(n.SECTION_UNREAD_COUNT)},D=function(a){if(r){var b=B(a),c=parseInt(b.text());c=c+1;b.text(c)}},E=function(a){if(r){var b=B(a),c=parseInt(b.text());c=c-1;b.text(c)}},F=function(a){if(s){var b=C(a),c=parseInt(b.text());c=c-1;b.text(c);if(1>c){b.addClass("hidden")}}},G=function(a,b){return a.find("[data-conversation-id=\""+b+"\"]")},H=function(a,b){return a.find("[data-user-id=\""+b+"\"]")},I=function(a){a.find(n.MUTED_ICON_CONTAINER).removeClass("hidden")},J=function(a){a.find(n.MUTED_ICON_CONTAINER).addClass("hidden")},K=function(a){a.find(n.BLOCKED_ICON_CONTAINER).removeClass("hidden")},L=function(a){a.find(n.BLOCKED_ICON_CONTAINER).addClass("hidden")},M=function(a,b,d){var e=a.find(n.CONVERSATION);if(!e.length){var f=l.getRoot(a);l.showContent(f);l.hideEmptyMessage(f)}q[b.id]=b;return z([b],d).then(function(b){var c=l.getContentContainer(a);return c.prepend(b)}).then(function(){return D(a)}).catch(c.exception)},N=function(a,b){b.remove();E(a);var c=a.find(n.CONVERSATION);if(!c.length){var d=l.getRoot(a);l.hideContent(d);l.showEmptyMessage(d)}},O=function(a,b){var c=b.find(n.UNREAD_COUNT);c.text("0");c.addClass("hidden");F(a)},P=function(f,g,h,m,o,p){var r=l.getRoot(g),s=function(a){var b=parseInt(a.type,10);if(m&&0>m.indexOf(b)||o&&!a.isFavourite||!o&&a.isFavourite){return!1}return!0},t=g.find(n.TOGGLE);g.css("min-height",t.outerHeight());g.on("show.bs.collapse",function(){u(g);l.show(r,h,function(a,b,d){return z(b,d).then(function(b){a.append(b);return b}).catch(c.exception)})});g.on("hidden.bs.collapse",function(){v(g)});d.subscribe(i.CONTACT_BLOCKED,function(a){var b=H(g,a);if(b.length){K(b)}});d.subscribe(i.CONTACT_UNBLOCKED,function(a){var b=H(g,a);if(b.length){L(b)}});d.subscribe(i.CONVERSATION_SET_MUTED,function(a){var b=a.id,c=G(g,b);if(c.length){I(c)}});d.subscribe(i.CONVERSATION_UNSET_MUTED,function(a){var b=a.id,c=G(g,b);if(c.length){J(c)}});d.subscribe(i.CONVERSATION_NEW_LAST_MESSAGE,function(a){if(!s(a)){return}var b=a.loggedInUserId,d=a.id,e=G(g,d);a=y(a);if(e.length){var f=l.getContentContainer(g);z([a],b).then(function(a){f.prepend(a);e.remove();return a}).catch(c.exception)}else{M(g,a,b)}});d.subscribe(i.CONVERSATION_DELETED,function(a){var b=G(g,a);delete q[a];if(b.length){N(g,b)}});d.subscribe(i.CONVERSATION_READ,function(a){var b=G(g,a);if(b.length){O(g,b)}});d.subscribe(i.CONVERSATION_SET_FAVOURITE,function(a){var b=null;if(s(a)){b=G(g,a.id);if(!b.length){M(g,y(a),a.loggedInUserId)}}else{b=G(g,a.id);if(b.length){N(g,b)}}});d.subscribe(i.CONVERSATION_UNSET_FAVOURITE,function(a){var b=null;if(s(a)){b=G(g,a.id);if(!b.length){M(g,y(a),a.loggedInUserId)}}else{b=G(g,a.id);if(b.length){N(g,b)}}});b.define(g,[b.events.activate]);g.on(b.events.activate,n.CONVERSATION,function(b,c){var d=a(b.target).closest(n.CONVERSATION),e=d.attr("data-conversation-id"),g=q[e];j.go(f,k.VIEW_CONVERSATION,g,p);c.originalEvent.preventDefault()})};return{show:function show(b,d,e,f,g,h,i,j,k){var m=a(e);if(!m.attr("data-init")){var n=A(g,h,0);P(b,m,n,g,h,k);if(t(m)){u(m);var o=l.getRoot(m);l.show(o,n,function(a,b,d){return z(b,d).then(function(b){a.append(b);return b}).catch(c.exception)})}i.then(function(a){w(m,a);r=!0}).catch(function(){});j.then(function(a){x(m,a);s=!0}).catch(function(){});m.attr("data-init",!0)}},isVisible:t}});
//# sourceMappingURL=message_drawer_view_overview_section.min.js.map
