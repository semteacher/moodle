{"version":3,"sources":["../src/form.js"],"names":["define","$","Str","Notification","Ajax","Templates","SortableList","ModalForm","confirmDelete","id","type","component","area","itemid","get_strings","done","s","confirm","func","call","methodname","args","then","response","render","html","js","replaceNode","fail","exception","createNewCategory","promises","categoryid","window","location","href","createNewField","element","returnFocus","closest","querySelector","form","formClass","getAttribute","modalConfig","title","get_string","addEventListener","events","FORM_SUBMITTED","reload","show","editField","init","mainlist","attr","on","e","preventDefault","currentTarget","categoryName","find","sortCat","moveHandlerSelector","getElementName","el","Deferred","resolve","evt","info","positionChanged","data","beforeid","targetNextElement","stopPropagation","sort","getDestinationName","parentElement","afterElement","length","targetList","children","each","fields","nofields","append","remove","setTimeout","width"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module depends on the real jquery - and returns the non-global version of it.\n *\n * @module     core_customfield/form\n * @package    core_customfield\n * @copyright  2018 Toni Barbera\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/notification', 'core/ajax', 'core/templates', 'core/sortable_list',\n        'core_form/modalform', 'core/inplace_editable'],\n    function(\n        $, Str, Notification, Ajax, Templates, SortableList, ModalForm) {\n\n    /**\n     * Display confirmation dialogue\n     *\n     * @param {Number} id\n     * @param {String} type\n     * @param {String} component\n     * @param {String} area\n     * @param {Number} itemid\n     */\n    var confirmDelete = function(id, type, component, area, itemid) {\n        Str.get_strings([\n            {'key': 'confirm'},\n            {'key': 'confirmdelete' + type, component: 'core_customfield'},\n            {'key': 'yes'},\n            {'key': 'no'},\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                var func = (type === 'field') ? 'core_customfield_delete_field' : 'core_customfield_delete_category';\n                Ajax.call([\n                    {methodname: func, args: {id: id}},\n                    {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n                ])[1].then(function(response) {\n                    return Templates.render('core_customfield/list', response);\n                }).then(function(html, js) {\n                    Templates.replaceNode($('[data-region=\"list-page\"]'), html, js);\n                    return null;\n                }).fail(Notification.exception);\n            });\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Creates a new custom fields category with default name and updates the list\n     *\n     * @param {String} component\n     * @param {String} area\n     * @param {Number} itemid\n     */\n    var createNewCategory = function(component, area, itemid) {\n        var promises = Ajax.call([\n                {methodname: 'core_customfield_create_category', args: {component: component, area: area, itemid: itemid}},\n                {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n            ]),\n            categoryid;\n\n        promises[0].then(function(response) {\n            categoryid = response;\n            return null;\n        }).fail(Notification.exception);\n\n        promises[1].then(function(response) {\n            return Templates.render('core_customfield/list', response);\n        }).then(function(html, js) {\n            Templates.replaceNode($('[data-region=\"list-page\"]'), html, js);\n            window.location.href = '#category-' + categoryid;\n            return null;\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Create new custom field\n     *\n     * @param {HTMLElement} element\n     */\n    var createNewField = function(element) {\n        const returnFocus = element.closest(\".action-menu\").querySelector(\".dropdown-toggle\");\n        const form = new ModalForm({\n            formClass: \"core_customfield\\\\field_config_form\",\n            args: {\n                categoryid: element.getAttribute('data-categoryid'),\n                type: element.getAttribute('data-type'),\n            },\n            modalConfig: {\n                title: Str.get_string('addingnewcustomfield', 'core_customfield', element.getAttribute('data-typename')),\n            },\n            returnFocus,\n        });\n        form.addEventListener(form.events.FORM_SUBMITTED, () => window.location.reload());\n        form.show();\n    };\n\n    /**\n     * Edit custom field\n     *\n     * @param {HTMLElement} element\n     */\n    var editField = function(element) {\n        const form = new ModalForm({\n            formClass: \"core_customfield\\\\field_config_form\",\n            args: {\n                id: element.getAttribute('data-id'),\n            },\n            modalConfig: {\n                title: Str.get_string('editingfield', 'core_customfield', element.getAttribute('data-name')),\n            },\n            returnFocus: element,\n        });\n        form.addEventListener(form.events.FORM_SUBMITTED, () => window.location.reload());\n        form.show();\n    };\n\n    return {\n        /**\n         * Initialise the custom fields manager\n         */\n        init: function() {\n            var mainlist = $('#customfield_catlist'),\n                component = mainlist.attr('data-component'),\n                area = mainlist.attr('data-area'),\n                itemid = mainlist.attr('data-itemid');\n            $(\"[data-role=deletefield]\").on('click', function(e) {\n                confirmDelete($(this).attr('data-id'), 'field', component, area, itemid);\n                e.preventDefault();\n            });\n            $(\"[data-role=deletecategory]\").on('click', function(e) {\n                confirmDelete($(this).attr('data-id'), 'category', component, area, itemid);\n                e.preventDefault();\n            });\n            $('[data-role=addnewcategory]').on('click', function() {\n                createNewCategory(component, area, itemid);\n            });\n            $('[data-role=addfield]').on('click', function(e) {\n                createNewField(e.currentTarget);\n                e.preventDefault();\n            });\n            $('[data-role=editfield]').on('click', function(e) {\n                editField(e.currentTarget);\n                e.preventDefault();\n            });\n\n            var categoryName = function(element) {\n                return element\n                    .closest('[data-category-id]')\n                    .find('[data-inplaceeditable][data-itemtype=category][data-component=core_customfield]')\n                    .attr('data-value');\n            };\n\n            // Sort category.\n            var sortCat = new SortableList(\n                $('#customfield_catlist .categorieslist'),\n                {moveHandlerSelector: '.movecategory [data-drag-type=move]'}\n            );\n\n            sortCat.getElementName = function(el) {\n                return $.Deferred().resolve(categoryName(el));\n            };\n\n            $('[data-category-id]').on('sortablelist-drop', function(evt, info) {\n                if (info.positionChanged) {\n                    var promises = Ajax.call([\n                        {\n                            methodname: 'core_customfield_move_category',\n                            args: {\n                                id: info.element.data('category-id'),\n                                beforeid: info.targetNextElement.data('category-id')\n                            }\n\n                        },\n                    ]);\n                    promises[0].fail(Notification.exception);\n                }\n                evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n            });\n\n            // Sort fields.\n            var sort = new SortableList(\n                $('#customfield_catlist .fieldslist tbody'),\n                {moveHandlerSelector: '.movefield [data-drag-type=move]'}\n            );\n\n            sort.getDestinationName = function(parentElement, afterElement) {\n                if (!afterElement.length) {\n                    return Str.get_string('totopofcategory', 'customfield', categoryName(parentElement));\n                } else if (afterElement.attr('data-field-name')) {\n                    return Str.get_string('afterfield', 'customfield', afterElement.attr('data-field-name'));\n                } else {\n                    return $.Deferred().resolve('');\n                }\n            };\n\n            $('[data-field-name]').on('sortablelist-drop', function(evt, info) {\n                evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n                if (info.positionChanged) {\n                    var promises = Ajax.call([\n                        {\n                            methodname: 'core_customfield_move_field',\n                            args: {\n                                id: info.element.data('field-id'),\n                                beforeid: info.targetNextElement.data('field-id'),\n                                categoryid: Number(info.targetList.closest('[data-category-id]').attr('data-category-id'))\n                            },\n                        },\n                    ]);\n                    promises[0].fail(Notification.exception);\n                }\n            }).on('sortablelist-drag', function(evt) {\n                evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n                // Refreshing fields tables.\n                Str.get_string('therearenofields', 'core_customfield').then(function(s) {\n                    $('#customfield_catlist .categorieslist').children().each(function() {\n                        var fields = $(this).find($('.field')),\n                            nofields = $(this).find($('.nofields'));\n                        if (!fields.length && !nofields.length) {\n                            $(this).find('tbody').append(\n                                '<tr class=\"nofields\"><td colspan=\"5\">' + s + '</td></tr>'\n                            );\n                        }\n                        if (fields.length && nofields.length) {\n                            nofields.remove();\n                        }\n                    });\n                    return null;\n                }).fail(Notification.exception);\n            });\n\n            $('[data-category-id], [data-field-name]').on('sortablelist-dragstart',\n                function(evt, info) {\n                    setTimeout(function() {\n                        $('.sortable-list-is-dragged').width(info.element.width());\n                    }, 501);\n                }\n            );\n\n        }\n    };\n});\n"],"file":"form.min.js"}