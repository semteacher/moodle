define ("block_myoverview/view",["jquery","block_myoverview/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","block_myoverview/selectors","core/paged_content_events"],function(a,b,c,d,e,f,g,h,i,j){var k={COURSE_REGION:"[data-region=\"course-view-content\"]",ACTION_HIDE_COURSE:"[data-action=\"hide-course\"]",ACTION_SHOW_COURSE:"[data-action=\"show-course\"]",ACTION_ADD_FAVOURITE:"[data-action=\"add-favourite\"]",ACTION_REMOVE_FAVOURITE:"[data-action=\"remove-favourite\"]",FAVOURITE_ICON:"[data-region=\"favourite-icon\"]",ICON_IS_FAVOURITE:"[data-region=\"is-favourite\"]",ICON_NOT_FAVOURITE:"[data-region=\"not-favourite\"]",PAGED_CONTENT_CONTAINER:"[data-region=\"page-container\"]"},l={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"core_course/no-courses"},m=[12,24,48,96,0],n=[],o=0,p=0,q=0,r=null,s=function(a){var b=a.find(i.courseView.region);return{display:b.attr("data-display"),grouping:b.attr("data-grouping"),sort:b.attr("data-sort"),displaycategories:b.attr("data-displaycategories")}},t={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,persistentLimitKey:"block_myoverview_user_paging_preference"},u=function(a,c){return b.getEnrolledCoursesByTimeline({offset:o,limit:c,classification:a.grouping,sort:a.sort})},v=function(a,b){return a.find(k.FAVOURITE_ICON+"[data-course-id=\""+b+"\"]")},w=function(a,b){return a.find("[data-region=\"paged-content-page\"][data-page=\""+b+"\"]")},x=function(a){return a.attr("data-course-id")},y=function(a,b){var c=v(a,b),d=c.find(k.ICON_IS_FAVOURITE);d.addClass("hidden");d.attr("aria-hidden",!0);var e=c.find(k.ICON_NOT_FAVOURITE);e.removeClass("hidden");e.attr("aria-hidden",!1)},z=function(a,b){var c=v(a,b),d=c.find(k.ICON_IS_FAVOURITE);d.removeClass("hidden");d.attr("aria-hidden",!1);var e=c.find(k.ICON_NOT_FAVOURITE);e.addClass("hidden");e.attr("aria-hidden",!0)},A=function(a,b){return a.find("[data-action=\"add-favourite\"][data-course-id=\""+b+"\"]")},B=function(a,b){return a.find("[data-action=\"remove-favourite\"][data-course-id=\""+b+"\"]")},C=function(a,b){var c=B(a,b),e=A(a,b);F(b,!0).then(function(g){if(g){d.publish(h.favourited,b);c.removeClass("hidden");e.addClass("hidden");z(a,b)}else{f.alert("Starring course failed","Could not change favourite state")}}).catch(f.exception)},D=function(a,b){var c=B(a,b),e=A(a,b);F(b,!1).then(function(g){if(g){d.publish(h.unfavorited,b);c.addClass("hidden");e.removeClass("hidden");y(a,b)}else{f.alert("Starring course failed","Could not change favourite state")}}).catch(f.exception)},E=function(b,d){var e=x(d),h=b.find("[data-region=\"paging-bar\"]"),i=parseInt(h.attr("data-active-page-number")),j=n[i],k=j.courses.reduce(function(a,b){if(e!=b.id){a.push(b)}return a},[]);if(n[i+1]!=void 0){var l=n[i+1].courses.slice(0,1);n.forEach(function(b,c){if(c>i){var d=[];if(n[c+1]!=void 0){d=n[c+1].courses.slice(0,1)}n[c].courses=a.merge(n[c].courses.slice(1),d)}});k=a.merge(k,l)}if(p==i+1&&0==n[i+1].courses.length){var m=b.find("[data-region=\"paged-content-container\"]");c.resetLastPageNumber(a(m).attr("id"),i)}n[i].courses=k;o--;var q=w(b,i);G(b,n[i]).then(function(a,b){return g.replaceNodeContents(q,a,b)}).catch(f.exception);n.forEach(function(a,c){if(c>i){var d=w(b,c);d.remove()}})},F=function(a,c){return b.setFavouriteCourses({courses:[{id:a,favourite:c}]}).then(function(b){if(0==b.warnings.length){n.forEach(function(b){b.courses.forEach(function(d,e){if(d.id==a){b.courses[e].isfavourite=c}})});return!0}else{return!1}}).catch(f.exception)},G=function(a,b){var c=s(a),d="";if("card"==c.display){d=l.COURSES_CARDS}else if("list"==c.display){d=l.COURSES_LIST}else{d=l.COURSES_SUMMARY}if("on"!=c.displaycategories){b.courses=b.courses.map(function(a){delete a.coursecategory;return a})}if(b.courses.length){return g.render(d,{courses:b.courses})}else{var e=a.find(i.courseView.region).attr("data-nocoursesimg");return g.render(l.NOCOURSES,{nocoursesimg:e})}},H=function(a){this.find(i.courseView.region).attr("data-paging",a)},I=function(a,b){var c=b+j.SET_ITEMS_PER_PAGE_LIMIT;d.subscribe(c,H.bind(a))},J=function(b){r="block_myoverview_"+b.attr("id")+"_"+Math.random();var d=parseInt(b.find(i.courseView.region).attr("data-paging"),10),e=m.map(function(a){var b=!1;if(a==d){b=!0}return{value:a,active:b}}),h=parseInt(b.find(i.courseView.region).attr("data-totalcoursecount"),10);if(h){e=e.filter(function(a){return a.value<h})}var j=s(b),k=a.extend({},t);k.eventNamespace=r;var l=c.createWithLimit(e,function(c,d){var e=[];c.forEach(function(c){var g=c.pageNumber,h=0<c.limit?c.limit:0;if(q!=h){n=[];o=0;p=0}if(p==g){d.allItemsLoaded(p);e.push(G(b,n[g]));return}q=h;if(n[g+1]==void 0){if(n[g]==void 0){h*=2}}var i=u(j,h).then(function(e){var f=e.courses,h=0,i=[];if(n[g]!=void 0){i=n[g].courses;var j=i.length;if(j<c.limit){h=c.limit-j;i=a.merge(n[g].courses,f.slice(0,h))}}else{h=c.limit;i=0<c.limit?f.slice(0,c.limit):f}n[g]={courses:i};var k=h?f.slice(h,f.length):[];if(k.length){n[g+1]={courses:k}}if(n[g].courses.length<c.limit||!k.length){p=g;d.allItemsLoaded(g)}else if(n[g+1]!=void 0&&n[g+1].courses.length<c.limit){p=g+1}o=e.nextoffset;return G(b,n[g])}).catch(f.exception);e.push(i)});return e},k);l.then(function(a,c){I(b,r);return g.replaceNodeContents(b.find(i.courseView.region),a,c)}).catch(f.exception)},K=function(c){e.define(c,[e.events.activate]);c.on(e.events.activate,k.ACTION_ADD_FAVOURITE,function(b,d){var e=a(b.target).closest(k.ACTION_ADD_FAVOURITE),f=x(e);C(c,f);d.originalEvent.preventDefault()});c.on(e.events.activate,k.ACTION_REMOVE_FAVOURITE,function(b,d){var e=a(b.target).closest(k.ACTION_REMOVE_FAVOURITE),f=x(e);D(c,f);d.originalEvent.preventDefault()});c.on(e.events.activate,k.FAVOURITE_ICON,function(a,b){b.originalEvent.preventDefault()});c.on(e.events.activate,k.ACTION_HIDE_COURSE,function(d,e){var f=a(d.target).closest(k.ACTION_HIDE_COURSE),g=x(f);b.updateUserPreferences({preferences:[{type:"block_myoverview_hidden_course_"+g,value:!0}]});E(c,f);e.originalEvent.preventDefault()});c.on(e.events.activate,k.ACTION_SHOW_COURSE,function(d,e){var f=a(d.target).closest(k.ACTION_SHOW_COURSE),g=x(f);b.updateUserPreferences({preferences:[{type:"block_myoverview_hidden_course_"+g,value:null}]});E(c,f);e.originalEvent.preventDefault()})},L=function(b){b=a(b);n=[];p=0;o=0;J(b);if(!b.attr("data-init")){K(b);b.attr("data-init",!0)}},M=function(a){if(0<n.length){n.forEach(function(b,c){var d=w(a,c);G(a,b).then(function(a,b){return g.replaceNodeContents(d,a,b)}).catch(f.exception)})}else{L(a)}};return{init:L,reset:M}});
//# sourceMappingURL=view.min.js.map
